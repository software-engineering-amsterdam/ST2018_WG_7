
module Lecture6

where 

import System.Random
import Data.Bits


-- == Exercise 1 == --
exM :: Integer -> Integer -> Integer -> Integer
exM _ _ 1 = 0
exM _ 0 _ = 1
exM b e m | e `mod` 2 == 1 = ((exM b (e - 1) m) * b) `mod` m
          | otherwise      = (exM (b^2  `mod` m) (e `div` 2) m) `mod` m

-- == Exercise 2 == --

{-
*Lecture6> :set +s
*Lecture6> exM (5*(10^256)) 1000000 497
400
(0.00 secs, 97,792 bytes)
*Lecture6> expM (5*(10^256)) 1000000 497
400
(9.81 secs, 302,577,920 bytes)
-}

-- == Exercise 3 == --
composites :: [Integer]
composites = [n | n <- [2..], not . prime $ n]

-- == Exercise 4 == --
leastCompositeTestFermat :: Int -> [Integer] -> IO Integer
leastCompositeTestFermat k (c:cs) = do
                                      r <- primeTestsF k c
                                      if (r) then return c 
                                      else leastCompositeTestFermat k cs

{-
*Lecture6> leastCompositeTestFermat 1 composites
57
*Lecture6> leastCompositeTestFermat 2 composites
341
*Lecture6> leastCompositeTestFermat 3 composites
2821
-}

-- == Exercise 5 == --
carmichael :: [Integer]
carmichael = [ (6*k+1)*(12*k+1)*(18*k+1) | 
               k <- [2..], 
               prime (6*k+1), 
               prime (12*k+1), 
               prime (18*k+1) ]

{-
*Lecture6> leastCompositeTestFermat 1 carmichael
294409
*Lecture6> leastCompositeTestFermat 2 carmichael
294409
*Lecture6> leastCompositeTestFermat 3 carmichael
294409
-}

-- == Exercise 6 == --
leastCompositeTestMR :: Int -> [Integer] -> IO Integer
leastCompositeTestMR k (c:cs) = do
                                  r <- primeMR k c
                                  if (r) then return c 
                                  else leastCompositeTestMR k cs

{-
*Lecture6> leastCompositeTestMR  1 carmichael
9624742921
*Lecture6> leastCompositeTestMR  2 carmichael
2173577642709409
*Lecture6> leastCompositeTestMR  3 carmichael
61301920303157041
*Lecture6>
-}

-- == Exercise 6-2 == --
mersennePrime :: Int -> [Integer] -> IO [Integer]
mersennePrime k (p:ps) = do 
                           let maybeMP = 2^p - 1
                           r <- primeMR k maybeMP
                           if (r) then putStrLn ((show p) ++ ", " ++ (show maybeMP)) else putStr ""
                           mersennePrime k ps

{-
2, 3
3, 7
5, 31
7, 127
13, 8191
17, 131071
19, 524287
31, 2147483647
61, 2305843009213693951
89, 618970019642690137449562111
107, 162259276829213363391578010288127
127, 170141183460469231731687303715884105727
521, 6864797660130609714981900799081393217269435300143305409394463459185543183397656052122559640661454554977296311391480858037121987999716643812574028291115057151
607, 531137992816767098689588206552468627329593117727031923199444138200403559860852242739162502265229285668889329486246501015346579337652707239409519978766587351943831270835393219031728127
1279, 10407932194664399081925240327364085538615262247266704805319112350403608059673360298012239441732324184842421613954281007791383566248323464908139906605677320762924129509389220345773183349661583550472959420547689811211693677147548478866962501384438260291732348885311160828538416585028255604666224831890918801847068222203140521026698435488732958028878050869736186900714720710555703168729087
2203, 1475979915214180235084898622737381736312066145333169775147771216478570297878078949377407337049389289382748507531496480477281264838760259191814463365330269540496961201113430156902396093989090226259326935025281409614983499388222831448598601834318536230923772641390209490231836446899608210795482963763094236630945410832793769905399982457186322944729636418890623372171723742105636440368218459649632948538696905872650486914434637457507280441823676813517852099348660847172579408422316678097670224011990280170474894487426924742108823536808485072502240519452587542875349976558572670229633962575212637477897785501552646522609988869914013540483809865681250419497686697771007
2281, 446087557183758429571151706402101809886208632412859901111991219963404685792820473369112545269003989026153245931124316702395758705693679364790903497461147071065254193353938124978226307947312410798874869040070279328428810311754844108094878252494866760969586998128982645877596028979171536962503068429617331702184750324583009171832104916050157628886606372145501702225925125224076829605427173573964812995250569412480720738476855293681666712844831190877620606786663862190240118570736831901886479225810414714078935386562497968178729127629594924411960961386713946279899275006954917139758796061223803393537381034666494402951052059047968693255388647930440925104186817009640171764133172418132836351
3217, 259117086013202627776246767922441530941818887553125427303974923161874019266586362086201209516800483406550695241733194177441689509238807017410377709597512042313066624082916353517952311186154862265604547691127595848775610568757931191017711408826252153849035830401185072116424747461823031471398340229288074545677907941037288235820705892351068433882986888616658650280927692080339605869308790500409503709875902119018371991620994002568935113136548829739112656797303241986517250116412703509705427773477972349821676443446668383119322540099648994051790241624056519054483690809616061625743042361721863339415852426431208737266591962061753535748892894599629195183082621860853400937932839420261866586142503251450773096274235376822938649407127700846077124211823080804139298087057504713825264571448379371125032081826126566649084251699453951887789613650248405739378594599444335231188280123660406262468609212150349937584782292237144339628858485938215738821232393687046160677362909315071
4253, 190797007524439073807468042969529173669356994749940177394741882673528979787005053706368049835514900244303495954950709725762186311224148828811920216904542206960744666169364221195289538436845390250168663932838805192055137154390912666527533007309292687539092257043362517857366624699975402375462954490293259233303137330643531556539739921926201438606439020075174723029056838272505051571967594608350063404495977660656269020823960825567012344189908927956646011998057988548630107637380993519826582389781888135705408653045219655801758081251164080554609057468028203308718724654081055323215860189611391296030471108443146745671967766308925858547271507311563765171008318248647110097614890313562856541784154881743146033909602737947385055355960331855614540900081456378659068370317267696980001187750995491090350108417050917991562167972281070161305972518044872048331306383715094854938415738549894606070722584737978176686422134354526989443028353644037187375385397838259511833166416134323695660367676897722287918773420968982326089026150031515424165462111337527431154890666327374921446276833564519776797633875503548665093914556482031482248883127023777039667707976559857333357013727342079099064400455741830654320379350833236245819348824064783585692924881021978332974949906122664421376034687815350484991
4423, 285542542228279613901563566102164008326164238644702889199247456602284400390600653875954571505539843239754513915896150297878399377056071435169747221107988791198200988477531339214282772016059009904586686254989084815735422480409022344297588352526004383890632616124076317387416881148592486188361873904175783145696016919574390765598280188599035578448591077683677175520434074287726578006266759615970759521327828555662781678385691581844436444812511562428136742490459363212810180276096088111401003377570363545725120924073646921576797146199387619296560302680261790118132925012323046444438622308877924609373773012481681672424493674474488537770155783006880852648161513067144814790288366664062257274665275787127374649231096375001170901890786263324619578795731425693805073056119677580338084333381987500902968831935913095269821311141322393356490178488728982288156282600813831296143663845945431144043753821542871277745606447858564159213328443580206422714694913091762716447041689678070096773590429808909616750452927258000843500344831628297089902728649981994387647234574276263729694848304750917174186181130688518792748622612293341368928056634384466646326572476167275660839105650528975713899320211121495795311427946254553305387067821067601768750977866100460014602138408448021225053689054793742003095722096732954750721718115531871310231057902608580607
9689, 4782202788054612029528392986600059097414971724022365008513345109918378950942662970278927686112707894586824720981524256319306585052676834087480834429433264797425893247623688331021633208954847354805799943341309825989013743806187109581043148680813778321530496715601563282624414040398143207622036272190408590790537203475256105564071579263867875240985573356522656108542128577321057879052328865035355873615679363655889925711574420153832091752422843046918811427400662135559303516853703976812686385750376227787949580582081831261725701003498206512329872677233489510953469375683037038373999696771585788905639115522613405495707184524158219208223766442059014593330657009722153962376853423770486138578089775621301167811299166407361746606697808186757966914671246073712904200588408923186387737887675292886953797066980967406053530122853539036965490224784924649007954898678503314655546475504501686187354866964374552614120640782949622452027788962138602665933147687696322089504278791624651519312327831756553779377194524673395819281486668576384019590720179413349582970319393884388810494546040342087536563628332152073181614300721769371426238517540520845214665313301183551962591849558938499025348780376716477073930634436840084468255937443451690315999349137664638968972614199015304906547819056227171224947070739716300953775743441307920501863532234466545645695774331885044978250148663467372130392099894852145190998232878772486650513010816769902892518719250066947215706536216248696240569256865554296221552211560427778662545936998801070186162601476474293459830183651273363462732675883060701410359254829149774339297173680765610959599911309189788238350131635672661435969218239977196933874395403996623675580528211207136396370858056051160781770985452576988032333812939272752101944629527490313835551985197095928885236415301789218675141014541203096191270934369039522098280317668942061325572349643638403056487349290884223786292887472231219032385281034091824306618947740727265524284893304474861454942076799041739447165838281671410435831206790501914527326287370339974707206016882562827404270170322606727980343479326425730091839813077719322455394763960606588214326603156141490740557698055166263044447583756711516490181193442236859424151843795389335765432129944054855345155859273424561825146813714720606287781021240923708021492298349635179527270302962970156927686511635050080407282674252362644695710769768866137302789313609674382719017385508484663373476120843567983065059558072935110637544240807350667082987233779768874938983584523095638996120616318634391967112086464384649470963230072729200912586147267999762496709852769503535733924416202657720741248683592202828983311140833923302433917797976990311425843619350936754483811194408812763388084204451804912454383884180800945275626668057628954763384641305107753773247082495804533355717481965025070819730466422826105697510564289798951182192885976352229053898948737614642139910911535864505818992696826225754111
9941, 34608828249085121524296039576741331672262866890023854779048928344500622080983411446436437554415370753366448674763505018641470709332373970608376690404229265789647993709760358469552319045484910050304149809818540283507159683562232941968059762281334544739720849260904855192770626054911793590389060795981163838721432994278763633095377438194844866471124967685798888172212033000821469684464956146997194126921284336206463313859537577200462442029064681326087558257488470489384243989270236884978643063093004422939603370010546595386302009073043944482202559097406700597330570799507832963130938739885080198416258635194522913042562936679859587495721031173747796418895060701941717506001937152430032363631934265798516236047451209089864707430780362298307038193445486493756647991804258775574973833903315735082891029392359352758617185019942554834671861074548772439880729606244911940066680112823824095816458261761861746604034802056466823143718255492784779380991749580255263323326536457743894150848953969902818530057870876229329803338285735419228259022169602665532210834789602051686546011466737981306056247480055071718250333737502267307344178512950738594330684340802698228963986562732597175372087295649072830289749771358330867951508710859216743218522918811670637448496498549094430541277444079407989539857469452772132166580885754360477408842913327292948696897496141614919739845432835894324473601387609643750514699215032683744527071718684091832170948369396280061184593746143589068811190253101873595319156107319196071150598488070027088705842749605203063194191166922106176157609367241948160625989032127984748081075324382632093913796444665700601391278360323002267434295194325607280661260119378719405151497555187549252134264394645963853964913309697776533329401822158003182889278072368602128982710306618115118964131893657845400296860012420391376964670183983594954112484565597312460737798777092071706710824503707457220155015899591766244957768006802482976673920392995410164224776445671222149803657927708412925555542817045572430846389988129960519227313987291200902060882060733762075892299473666405897427035811786879875694315078654420055603469625309399653955932310466430039146465805452965014040019423897552675534768248624631951431493188170905972588780111850281190559073677771187432814088678674286302108275149258477101296451833651979717375170900505673645964696355331369819296000267389583289299126738345726980325998955997501176664201042888546085699446442834195232948787488410595750197438786353119204210855804692460582533832967771946911459901921324984968810021189968284941331573164056304725480868921823442538199590383852412786840833479611419970101792978355653650755329138298654246225346827207503606740745956958127383748717825918527473164970582095181312905519242710280573023145554793628499010509296055849712377978984921839997037415897674154830708629145484724536724572622450131479992681684310464449439022250504859250834761894788889552527898400988196200014868575640233136509145628127191354858275083907891469979019426224883789463551
11213, 2814112013697373133393152975842584191818662382013600787892419349345515176682276313810715094745633257074198789308535071537342445016418881801789390548709414391857257571565758706478418356747070674633497188053050875416821624325680555826071110691946607460873056965360830571590242774934226866183966309185433462514537484258655982386235046029227507801410907163348439547781093397260096909677091843944555754221115477343760206979650067087884993478012977277878532807432236554020931571802310429923167588432457036104110850960439769038450365514022349625383665751207169661697352732236111926846454751701734527011379148175107820821297628946795631098960767492250494834254073334414121627833939461539212528932010726136689293688815665491671395174710452663709175753603774156855766515313827613727281696692633529666363787286539769941609107777183593336002680124517633451490439598324823836457251219406391432635639225604556042396004307799361927379900586400420763092320813392262492942076312933268033818471555255820639308889948665570202403815856313578949779767046261845327956725767289205262311752014786247813331834015084475386760526612217340579721237414485803725355463022009536301008145867524704604618862039093555206195328240951895107040793284825095462530151872823997171764140663315804309008611942578380931064748991594407476328437785848825423921170614938294029483257162979299388940695877375448948081108345293394327808452729789834135140193912419661799488795210328238112742218700634541149743657287232843426369348804878993471962403393967857676150371600196650252168250117793178488012000505422821362550520509209724459895852366827477851619190503254853115029403132178989005195751194301340277282730390683651120587895060198753121882187788657024007291784186518589977788510306743945896108645258766415692825664174470616153305144852273884549635059255410606458427323864109506687636314447514269094932953219924212594695157655009158521173420923275882063327625408617963032962033572563553604056097832111547535908988433816919747615817161606620557307000377194730013431815560750159027842164901422544571224546936793234970894954668425436412347785376194310030139080568383420772628618722646109707506566928102800033961704343991962002059794565527774913883237756792720065543768640792177441559278272350823092843683534396679150229676101834243787820420087274028617212684576388733605769491224109866592577360666241467280158988605523486345880882227855505706309276349415034547677180618296352866263005509222254318459768194126727603047460344175581029298320171226355234439676816309919127574206334807719021875413891580871529049187829308412133400910419756313021540478436604178446757738998632083586207992234085162634375406771169707323213988284943779122171985953605897902291781768286548287878180415060635460047164104095483777201737468873324068550430695826210304316336385311384093490021332372463463373977427405896673827544203128574874581960335232005637229319592369288171375276702260450911735069504025016667755214932073643654199488477010363909372005757899989580775775126621113057905717449417222016070530243916116705990451304256206318289297738303095152430549772239514964821601838628861446301936017710546777503109263030994747397618576207373447725441427135362428360863669327157635983045447971816718801639869547525146305655571843717916875669140320724978568586718527586602439602335283513944980064327030278104224144971883680541689784796267391476087696392191
19937, 43154247973881626480552355163379198390539350432267115051652505414033306801376580911304513629318584665545269938257648835317902217334584413909528269154609168019007875343741396296801920114486480902661414318443276980300066728104984095451588176077132969843762134621790396391341285205627619600513106646376648615994236675486537480241964350295935168662363909047948347692313978301377820785712419054474332844529183172973242310888265081321626469451077707812282829444775022680488057820028764659399164766265200900561495800344054353690389862894061792872011120833614808447482913547328367277879565648307846909116945866230169702401260240187028746650033445774570315431292996025187780790119375902863171084149642473378986267503308961374905766340905289572290016038000571630875191373979555047468154333253474991046248132504516341796551470575481459200859472614836213875557116864445789750886277996487304308450484223420629266518556024339339190844368921018424844677042727664601852914925277280922697538426770257333928954401205465895610347658855386633902546289962132643282425748035786233580608154696546932563833327670769899439774888526687278527451002963059146963875715425735534475979734463100678367393327402149930968778296741391514599602374213629898720611431410402147238998090962818915890645693934483330994169632295877995848993366747014871763494805549996163051541225403465297007721146231355704081493098663065733677191172853987095748167816256084212823380168625334586431254034670806135273543270714478876861861983320777280644806691125713197262581763151313596429547763576367837019349835178462144294960757190918054625114143666384189433852576452289347652454631535740468786228945885654608562058042468987372436921445092315377698407168198376538237748614196207041548106379365123192817999006621766467167113471632715481795877005382694393400403061700457691135349187874888923429349340145170571716181125795888889277495426977149914549623916394014822985025331651511431278802009056808456506818877266609831636883884905621822262933986548645669080672191704740408891349835685662428063231198520436826329415290752972798343429446509992206368781367154091702655772727391329424277529349082600585884766523150957417077831910016168475685658673192860882070179760307269849987354836042371734660257694347235506301744118874141292438958141549100609752216882230887611431996472330842380137110927449483557815037586849644585749917772869926744218369621137675101083278543794081749094091043084096774144708436324279476892056200427227961638669149805489831121244676399931955371484012886360748706479568669048574782855217054740113945929622177502575565811067452201448981991968635965361551681273982740760138899638820318776303668762730157584640042798880691862640268612686180883874939573818125022279689930267446255773959542469831637863000171279227151406034129902181570659650532600775823677398182129087394449859182749999007223592423334567850671186568839186747704960016277540625331440619019129983789914712515365200336057993508601678807687568562377857095255541304902927192220184172502357124449911870210642694565061384919373474324503966267799038402386781686809962015879090586549423504699190743519551043722544515740967829084336025938225780730880273855261551972044075620326780624448803490998232161231687794715613405793249545509528052518010123087258778974115817048245588971438596754408081313438375502988726739523375296641615501406091607983229239827240614783252892479716519936989519187808681221191641747710902480633491091704827441228281186632445907145787138351234842261380074621914004818152386666043133344875067903582838283562688083236575482068479639546383819532174522502682372441363275765875609119783653298312066708217149316773564340379289724393986744139891855416612295739356668612658271234696438377122838998040199739078061443675415671078463404673702403777653478173367084844734702056866636158138003692253382209909466469591930161626097920508742175670306505139542860750806159835357541032147095084278461056701367739794932024202998707731017692582046210702212514120429322530431789616267047776115123597935404147084870985465426502772057300900333847905334250604119503030001704002887892941404603345869926367501355094942750552591581639980523190679610784993580896683299297681262442314008657033421868094551740506448829039207316711307695131892296593509018623094810557519560305240787163809219164433754514863301000915916985856242176563624771328981678548246297376249530251360363412768366456175077031977457534912806433176539995994343308118470147158712816149394421276614228262909950055746981053206610001560295784656616193252269412026831159508949671513845195883217147982748879261851417819979034417285598607727220866677680426090308754823803345446566305619241308374452754668143015487710877728011086004325892262259413968285283497045571062757701421761565262725153407407625405149931989494459106414660534305378576709862520049864880961144869258603473714363659194013962706366851389299692869491805172556818508298824954954815796063169517658741420159798754273428026723452481263569157307213153739781041627653715078598504154797287663122946711348158529418816432825044466692781137474494898385064375787507376496345148625306383391555145690087891955315994462944493235248817599907119135755933382121706191477185054936632211157222920331148502487563303118018805685073569841580518118710778653953571296014372940865270407021924383167290323231567912289419486240594039074452321678019381871219092155460768444573578559513613304242206151356457513937270939009707237827101245853837678338161023397586854894230696091540249987907453461311923963852950754758058205625956600817743007191746812655955021747670922460866747744520875607859062334750627098328593480067789456169602494392813763495657599847485773553990957557313200809040830036446492219409934096948730547494301216165686750735749555882340303989874672975455060957736921559195480815514035915707129930057027117286252843197413312307617886797506784260195436760305990340708481464607278955495487742140753570621217198252192978869786916734625618430175454903864111585429504569920905636741539030968041471
21701, 44867916611904333479495141036159177872720902372938861301036480447512785609158053637162018395920183108689149613973035533621134551674715287880007134345347194681025732056939825423723521750452980127215084299527266875706892007262798468825185681532142985720637290299313726344463257416449344509835102458816789016394945893696705168502436180232259551672603295389186364437045681350697590862198047118901225352609650331560624641680529360950276322519541199378781611887950368067065467094570602703933944508795918017973611326798274338403964825448745270434393258865935311826270281291301767537362073560471706796018086986188192305477308263143033689309402401116023184218739861793173381674293624039080146446533167893142403441626243986354829868152963856856097613981370008545290902178852760181267516916666189196652889272405457548015727583223936389690623948268629738406595342536881770621194098884299042222510205198907427651269590866489020849331593183544730378438673619905441075619665362094087700417583472204239335761771260615063239687136058218014855376128809648109025328444692060981149171853122623214490315199270347679840250650446624361158632712607371820441076129040576076156413981966443384174935945557589269550551384444249641738589326431062350244259749888495427561113138125373546749571089212977055534105306317668036525450115619994704703080975001831039096328170193148671686659220369588362291591980963840251182084839045643052580945876198697254235294718583716788165976228557375284260972377346244685323620326927812128869122804644917707943186384476057711810558228653120572801809938250702311789320142979213175068746598525343177694757992501015403459055756096150131796369342571712916973547166474698856592132612717244249685861542410597610354729550125380584497109056463991926448357223209008827764713220228439775757230755516658614028292960947522709456751199752268424383084190316769975828969408161512929731166188774631973942613003505328030528435929861943028814647224393409604332129915709479716480001751152901047730022099226496393622633345405009361146955156338963448113785646130979933903537929751619768669550563002423706161236691536299577305442116055910462682405728304933022695634876033547918117176704431651372729753611485207957283097607765933169252913861287726833830000755907168496373643201886627226059186824987046158950280121480310106220821760865120562920439756658081153617726352709131801387158672559847396101178548655217308890158788609324326427919178121708326042669857675282709609677929532780738060001705557411238564945972873592110131239116174462947424279402757853073650206058072089139080813381552120237889176959032725532187981806390188976611966923383780080589571180304127953763426872458894003176440733448130784320760858250357720163697308151884697269173048039142351116460009341135465682559795451407065757164712682892684340399927996841540378943787439234382545562253973300003977291497945580368468642313784723553952911754115108385290054865563784523161325911184338403975092561182541488447059744171236348865292897919507096247432485742758096709852132553243687088002636637356883647209281384466468348661473539477676114713952390574283871138643608927689646270265436227072361361556969326026972555137795806131512078396392381117163021488319719122953967241849650035686516897636532829829413559438271078909648012546818155830670649731025924561052079518365511691315910359549578098542021850858860195694976630351366074278129451101792937644085504395275589852388064138602439346909569031381270272833205694814223411334423565977453887542395353485301546284835327702006873689327611630437966491140077951840154972590243416512380587609900111470825767310676939441942826834427612997756892340669203408743659224466633723212596650417249730825215118303577011272768581293371366148392778532335573122542905472394542069919985611732624482347646980930805586007081976261003097963198812882873782621377463926668786498204922447802136607398552526766227205124310008056632919363553194966717056709446690809053625020657218419836547624618595375352039018705449062959037038925284556675116361168237279922207920794703117075921951295707710873733317931433110923531405719416365240907518118794096775462324423434250371711420947553571555908465792580645089870615111865933553809003552706994499748706917899889082891225016257753453229705906397483096836459677640750701051127649136815511445021677568414826304009394300853762240103073543616073297109679097852591173721376034038403903797326084264850909622924265141840684883798695123898530601713627917934581206083528373369371952855787986368194089909153037760311683730584329384267492189510884229753903906808988993523259437606901944039838823315225488711871355530334671879703287493612171018890720047791219983006575690550227543246901734749051876793980240930546447655515405860615566182339568500526080685358056916078877218441535928716267560418132595102517522928981353833074067246933111570873295331815501725771241383698605105802286768924861382741652271179538064625778814288737402101220075694269814240934893379113612806306410045157701609671517543787442511524203121293023260598375610136932287924468473569626893292863959506611559181514200293625478634965230187600993204860736747921056014359652196606989325320755082356901630669240688685505174445515739151017185696401582807173431580481627122423292641208991071222953038343766541925054971737959169869292375645057151727543470106206531135735154136115144300015873080448570355596137321380062748881332031472142823024949510022409370177712994235289702790490255826941441774321618772576455298250619988354955614763200793811728997204477597638052792510878225745663494703701392574625552528908681553926116252158243953964293657171414581341823547346468074289772645946104841180801333621512150598625594195401601933368973292090945435953301875202828322848138663871822530516790587144451339179411203328134884327892252621182901800244630979609876813374281202935998128401633959108387881070976339195584757402099414224321539543476019604874975720230127703172732861447718691961098975942332752633167063512960112700154075209382155551695503282689329429789346503176351007528609841743736084042408094015850910964618482805649640269394165006760210370817982850495571836159005709917919149733735278914364020463842602726375487527643414975692020200079346255666615166515258291939313433912222614621242014153365037286833662921186290423547789663783785467893012638041082143785487398866487992341179948504338667781255945413472465246231194881401316071628427281713042247869185631200192333698966933544361629391311041730956501694662754558875644345191269279600693551809271956450264294092857410828353511882751
23209, 402874115778988778181873329071591767722438506891622420041029963578694595240887400867639861461466537103833299413586592359075505942560215384203202392505282949645966546812986702462936795598139258862134305524073117514011710850957577155764134526698071154024866570291655743611106521552616792435986397703408624275326274514077603381064824129105663607213717473307176156322769664543742767983969318459384059938379878060275572931297882085263728828117679720478536475397347975085800596808241438126653968141997207758226940295714228111203845566219741262180987691210467038513314695804493896376930579454464107580662751095564143792253350149446963327062164865068284526946953787948865977316436004163037670156288981621675415729125137439286714883498899856647713325489027165934178641826671600314908207707581913028677627336873027019891101782199420387568674902708563560335665422249993344641004256625323906242830818468942899074234949993913859729756509148940793762235052397899476747243354482142341818566675079971966290454555100106794831122873316939190687807078076069507534444543783013175183099338301868495249460351437732629139146367120478550987016051281632788132605645720897509405100164087829546634973283901954415020317318121023343421442100924240630449162568320542266025029163898709299519931364601129148550918588500543071567482692038979207121165184595857972650794067721766663304877552877530735512541831254657221163688520010481326670262947292075214957731951219393131136071700066722769000670606191390991061973242967512911264351947043296980084166552860987471716618776310267311799281849825634572094586351568980001270007699500229311699965157159517665682831428949194388823813435669597457534867460620737424901559011466473739067552420314197465985734592045469444007987504268282567422361912607903782885199294253733275346340104383835614315889419535761215302433931746650845594336694703703807737307164962815978286100833828641206436538659807846921750141914508632328601539864514384665868751711078980714897238167180581728616753062507511747249245808005997622111641863200180907569048105964570792432318670249656718941478701386677886972338475477550756278048908745855857140396160840915640000152942757067579080105948100791236006113816027294954023517657545229368410211569897436302803253236256834802174708129208380881582322497874260497465180326565377356632463319881488797716878813402070865003833358109311401638399789940308755319571548916779442616446407624398435974737254859567216330307251241356103982692307671884438420399664712045747717349853326279186496926627476702835365616635120395298094996813494640292537645025964806763617960757534317599906545186285779936362239640963157278962749735238734018031963137162294519353089671616839856140612934423376292800357002337948291195231891916319254587638023719991739894135357667509038890693762240291980336551006243082475037374270454634055589954829529267653294431255919681866264708150515182120867007206266224413578578766316288292200080204069908595880864904593530195791992836066271397322016336401432076989173442258953647032430558877151892524852554146167146883853769910561246320694705512457088921711978644056703135770947386634729787650241736975543224255147223770741629765650171444541115341186577164267009666521778404007908942572204437357536447013202320449087374359119884688896570653153635965699349888166816675325403419739923012069285047750708058098369546148066530512705922505763339363973448743551275283628656834670402770338901203538825863885273372725296802331175711226954450363493355782396416901236554095224408448515154810718941778144253019735772286555494888482992676834736600663066924318505506867453994455209613903356661381551303170707697066559694566821068447680650509746035384405738968952295270831628476713602096813200521662297702228641383037720127445077295416522867251086259308924256949130546482529205107067023263892250887651080363021211434271433397608989308330364300732585576535892044008832875413115983363441152995391893368657891779064964168643604233277423002160282408650562356013737533053786211598736805557064344886640795852215801092988641923941455936928232399558235098270821534926531103513400970081240298921105811469814438250610289016969531556231773644918713398451013610901563088260312670567852392406888546913219408585158313060052720828019956940355099824708223899549815719733824216351158321846675607771810334138571606559041577651060598586410945242414351010571013653342029095141793703879402055123962938698179828584589043431623461565217092474712504108095507185137084361406290374948975337884073889633379670194520143162505535982480557240745650789504233993776048710965080738857416484988531003380895803114702386171393470918048735414818380392458071193268641579841938267935481009786061474906992721678353184487194850249990636982112425783667423987765795687026140087895862977235482997376826723315374113237914901333805371711741433497851736832069992653855870002553569186840659098607217033947804144416745928019424098692156435119983976508231816318389379221957628808432933260158025696921301498898560750488043621000694853960738388398663132023687388772635827865444684904043842288121464832536246661065981285950218766526563040447477195329513732641090495498177569836233890464798843005307726003216676981448433911814358187830997562426197639363770484733809493659989183378814319610238163619306208581346901169487332307324999289816374403929506251166966203697910688044201904373375047065577539903412318702343216051705155579477611929334487133386363680801795105965377097317217740629067636115194380331872850516648735434607676631522745733922691440568189717446200213790341992006002410924699429964335507377264900571748863080009435280275806683231919932634328199443166043464046805502904952823468304240431789051431145750174780573029159376608897423116657754646993377252058996584317021186517859545402948554640815812580111812135719244094927777605138918240574534813561862500330654244571788812378520927064783435122985854726038472730062101845156241692016024941211265239314166182038758409312685384765540405212510964896838371037304156419933879530352086544022535109789602027747223650858853482671648101755365481354228091863805011621578883875669404903355089888549376208723682090564341102930475228163313059215959271226081949848477889353337470684677801928746328252980236259643089082064765819268977684271297091434221420402203204816051843790924312901306330991292496802744363898396613407782196679612383549415610569783891526919396336077461916416010666683822481030966646694241533372863428935782537171867644640829719942202233252584945211114561669570501261079454174419086577258210544440106662438203017786099053725933264345420108025868071488561671372008089600018372791881207012696110945775614694650737518542322556296640977293935894214414869438855358753606003397001637907083353780707434779613877126249098033493565718268305571578182703693122089543445743786026405786163677453587602709733484635893390989079294709002676276094965852942303062635499907856117575009515746557862539764756574427752110896827606786025282039152876055050854511817293890036743355523779264511
44497, 854509824303633803193300705318403036509901591304021058343269258282290064782167635856200500014457645861481315295253223674938340502225641436794294836286613933671922838722349286185054453799484919702814066298682412853022594582702532253637046393573819102339382603546705057592743425373988510067594258489091882652816984230481339231089370597522429657962221023625389786838476222562700937572849493656778309709848902611559817481821648562991414301186852631109919628014506891879938269919876375041476054570480393817802067642573802934320804004689212061263134937191146939217967863913998340450302066353316060446899821960016965149455247451256866120416455837785237889442736716622863694799063147972421915137281185223639485530939080700703965630524284803696329522594560178565231006428355914264455809535904827184567881970752815068646412535212946406293446404577519747900684536609902072584992617981311048365318249332003277695727334239248756022919323029881117042744212106822448167090688816268058419617823050362806871644195094989164027842731200313536528752898778625674473549278406773185197120724873440981199286044998761054195231373956949189989191876556229344730115045091462226103168618834097344609997156610133228831405954118698397360867836938451267026626659091843988180773279436086490179650284300557692234183476442984646309183072757232974100222299116389491938691664026821610953870032133749491829983634456251002018767911077341998982406542117192442961159639187837594167906896813306451433188950986000602255947701445471051471124124848433682921474574972057506821415068467850112481880920331630720013627342971796220098146625253125901337980386234817629898710708176158298693133149214166399431656277231164600237527367266776679870865785797830236117277818351059865801588376786510903900434642861824307368660843525509146180113489215970253073134536932334593263343428657338627378492178677797784904272941831813460434829238122857112185866161235173379896102730767761423558393178166224715620952758653591232586065130931612235961024495955052576313785415587572218003004463096123010675460429586233582774784375746614062343087428887376655420063237888060863198948004060435770727103254016551671980979670924439768697027789157597450820625427140967084876253330432907082362616208058343177345138018812833029933660200418178113067998719426282674176029537056946676010743381949863248322018120347951203883971813116798180480041145250934319940195212376997070020403473240618427512395565994017639267642387590352270623403841409398778197965052818880494122679879637450982929872559880623884514662196694567744027940130038179920182595248220029960545836068437836537220421151865495276144874163510998224619086027469138960543563366461310280362835876324827709909151758836738659026346983354907158533741172008557347289191834118874344507211706399728488280164719941918548596996410064074112835516746454014440640147699966792001636649078492049497299992037010722502767123614674570208325085786203978913246013088500640052780403783197363796495378941014322353383867757116808444859236033884177503488694746360263081077518495278672673007687714633814675074081403927708449052582362241943697206287236587208562293641356094566185255157887794517532173283111833000302025613005213405482252878149070265205440373545426910161611341185559050988906020137614109481965847736796392112521375419675323000779270489340923806543050956827559032136728828425649916323160041509893239953929650589544864646169009568125970129331389668409973033907297445999076186651095765310311061043682896569016209694536996136266470191569408033323541694057386738735231465391417715857531488577897250851792909910169470724853261427849940549334305896475592823992656458347993884214575074296814676874464971197215649974506724058916041508916049169707455165438683627351824021232173847650175009569246844585339764331444039879715595935280515640897481257047884715263635621831312250733095244741473379412994928937246504471873360093422945901669688636733052872215188392668343870518332217357980686070609320554480910523795553942258900948600643831553785127382196992543338144141784198002454900271443091682756574616685753240566083384505911986644720838738796540754497874824089314354427768560390125821906974331377915589874833096832220364826214637532467443257219325373542595632168868196845662314535257745740540690088721258932375726926780766042960522570262391944742291827500524719618152204706641289353527039250445951674387140964202979771525691667923635515333128240868122085666451405605834956472406582298196815961996323161565850516941679845809803706388743206005082498287908828447142468612698942513775417111948840517510717444158415311425872235504912292900931530294540012529260625223947584186787091065270997026119386422407099057687522692243445528559804365149519299366360636524787812055597948447738733157386435933019181691527123300142439165132639220658338166882600717005946057068109508190289169077800589855030939849414305609938324421065685342787335122628943893224737558800955291230162354473703668269418246876450051459098729949686427616991310346258467807714200493294634954267280195055460982624792493147249023081291160699372476860084646890874325382990275414749482976830377419937253467357638865913508180286605409768240640904878608687284690578097084189943966991203576327162981834473756946679902799601556403227035997733408463051882878040648605903489943500990090428817282136562244543138227751934870681977529470093118307377797864388134866337375506717466865840299561391687595163814871073257516237138953084739741321046512519898783055985137562909986862822821418697909218618375824776243596129635576799359999369344085923480717698699573491947266917238316136594697515748884132844396814671847273719744879357852879547726224395778018791817246412295326838150979939296919653496539270225341826037714755592301500206279366160321101433476538168211877778289236382492839507816309054101996807881965990251144060531583269667332503639847271289331205431366064069530883820899868706709436836481848789690764673023862695740597045358606957928324456815766130005846385401900094395353684780895776336253796523782075679613024968339290175813865387793255361742847784029992110588949340556741643663846869775018478118394443365250793299817506244603536408515810504456085656681183484766909632504119159101857786213084370375778253371993950568270608368720255920096107484259695785002799244185251870094775729333995933499076257379601075025939759382282614484710286255549932745375952696109293041118929794123755168354275719367365141154223682577274756986939801666353878982712419672047895827951421563601304219352939201617281945130711444593498910500078357202775578698708417758650476732444321615389586337183178052363104577036667976981794379775137254974699125521663805999652545541936035723389826056812617646779754277945047644116609828329736790436393517413288251558898045514749445906423194323706306414119366629747907481287373940832842913969451233186914869606743291916409591019592632025299628197611384253264924748540717955006148011213196330973338173358350731330358801176687055820667007316206485174294980719681580611007576366315566817988676676629818069714322226851713501056676703693691882424689948234282990975689672226518343470550974174195976295776513379484342672440028765751071277361281234011824451864987118511900268023620660925537819599017123223240195222037027161559785371968202312289222379716023280199762503203345842364475873165443711996121637218656014077109938287634462641911237643661498730924997478477798307306107972975765021697764315038032227248049476011713075846328424181343680728329020299532724418468785014598773583912750973647902334456053103347236956679606482172145264307156698559926286047178503741949513540448038604980058134803318961867847317924106411305428822060455457034623993478081873112040879949284318699106416865521492614531231783253320962518186939715705143181582332451403715983077334128673665133436729743874451580776248833276287003390901217261036364534945948597578267069197289616142254891035095245916484120686035290315924214004246222851715780026230502200012304905654599808044383293639930610712768452762188272135526848937482560309725734239359041881081604932493295818851065897194460578664420343244668944218859930843009169151416439747854996132480384642823239375104265690829603313763978877633592443681156487226034007047864955055396171494523624931526010865247828680422244153827517874928298622742605275785719186799859505979308352491593626969988121413269340766953822202945692532342274077693139016760771380343305198289191630235123888130456500445772972946518534337647490350165170146543325102202345905951720938063341522132865825600159040043213174225940378385162335105254933060024773771167209509009338521005232769588766592518165697175352104674517670696569105465127985627784868398418070770887556648506376679874586510201116038731912112614381982989015173251887069224596014819312276729672573465458064549365015500115328448677712179357286925172763809121710405012759558336757794987895061919977712975746432004968898100686118376848236917818928054045219935018646614556888891673782521226109539876603853518249396964141573474411786178864152187231072872681832426617408041561826083277082996504979905121576729761882674166062981961840205928992149503122068791348059470110958176511423269913276037734681753745733428156637089438932739933696432356682668732464139632035094818062195320955001580567851453434840805453125631107205858205890026353091573367671720125016243983573396956393115752805646325308011707276533642086384504961180674698139170920517060518064920905572492922057196081196237682745164205846001032313420319686537276432540345071367632274054907466295796072834575234227652980765772996039382235258886338751540189442236614051487377368191871254652241540528333803670931581186398680731835448665759542476167180453375355150728414382395794212745437166115535367048263957768441505047319734903176176353583999693271099471070016855442488574546932825424729408666367431733711263035317370459792311926982579362304589031818587148975192530703366798574784205700976688975137170702704092122565561067535398561047770288142891333643540586094191942881098885861170676614495216217663224969625604494749752841526809562332705130595227694664136670233457880177927254357892280283501771674153340181295757185220624956488625960241342854349445359997526435561960392392589534148436324133221048085564212838030416837663335740949389023767630410667756195923000289601031700507406595751284778714617941817407995143996744786287420431561654314601536316419773722086777893902300557814544690726153524427504853234241083524047092443029212029099057510938541927161209092151527496660113715920637523480328430989742744810118275178802273249944379671941834661049810424824484335554854300332454752382382575387785362503969349048207228022378600321077242427273559577596216705954978385577476832481767698691019969363764124908054104431258135562309403229995669410507869061560001668799471259677428825587266421236272771356548966731920925935827605895525944958390557775188182599430773976329437360627262869464537271395411127635295102553106088630644348895245378046988082281991300125435706980577758382748696320651710629889378007269601604348150095922464466723718089944069302233407247100092030141634979668048628892544474704539980677959253045377690089917491920942135794067331069174835878047355763069916910505856744867228478819552076510220321221144225115311556902621320151580940631531454823566207528919787538960710731134397251446863301951561400004159243550508846994979870220021654014363061263907055278823448015537418189345262220832101054862193900982756780966682798488261862603073406590467181148676985277920649376717780278320966958417359163686441603606338188292114506821091632091406602191783475767863949798191920391303037823635440366852329792530304401282072217590937306513920702609468017126262860885494045694567006749197056309580643372985177988939029566239014458631659924443381694125529837649434600565981192424844144940596207132164490577515769239206357734633567452508425758085518073722500745788910329276083662174307997019821662396368784000485410203494746501418379420966077237082321290470478615887034185693579996771486215404804695481122481571513704280852627012186267469991635981685640889473373475894097871907535351273155661295260715372756782780366420854197224596223931832477283860850556978410751616679570401202979195793508679229270695813501332563153166070154095763822082051684399748732729553965958532985987911797902110713318155368558266214589918316073370489457222186414248641266582577935019778268426880584442584972373506134982469960153759083758243333220265889317394698666742717430467634753497645506911473017508272050122325088825503782634226189081418110360232044483094917122073348832945196558930045450606186630066464264923682396019146123557820494410011041105352029248308941356759691092988813708083281472269286627276152071817520526023642930790051602960171096698266145887952446714972709623121336088800287469715461344195144343476677832930394086124235564902368800329544881012516861962147429738421449344065429019424751594247732152478118453408107243377529364274352501904296565836899003489345368013052920775677626638558887457826306248930171608249290273621192147578458420275754041934364280873277576348340883830877789952351851735368425837704493979337701560295930387002196518418354534911347404051951004651581481820521681180801097862520366245152535253445173913441503424092683220656401689350515658469355395408017218547191074429639783599094899320410039863575946472558059877105808942471773922977396345497637789562340536844867686961011228671
-}

-- == Exercise 7 == --


-- == Lecture code down here == --

factorsNaive :: Integer -> [Integer]
factorsNaive n0 = factors' n0 2 where 
  factors' 1 _ = []
  factors' n m 
    | n `mod` m == 0 = m : factors' (n `div` m) m
    | otherwise      =     factors' n (m+1)

factors :: Integer -> [Integer]
factors n0 = let
   ps0 = takeWhile (\ m -> m^2 <= n0) primes
 in factors' n0 ps0 where 
   factors' 1 _  = []
   factors' n [] = [n]
   factors' n (p:ps) 
    | n `mod` p == 0 = p: factors' (n `div` p) (p:ps)
    | otherwise      =    factors' n ps

prime :: Integer -> Bool
prime n = factors n == [n]

primes :: [Integer]
primes = 2 : filter prime [3..]

mers :: Integer -> Integer
mers 1  = 2^2-1;    mers 2  = 2^3-1;     mers 3  = 2^5-1
mers 4  = 2^7-1;    mers 5  = 2^13-1;    mers 6  = 2^17-1
mers 7  = 2^19-1;   mers 8  = 2^31-1;    mers 9  = 2^61-1
mers 10 = 2^89-1;   mers 11 = 2^107-1;   mers 12 = 2^127-1
mers 13 = 2^521-1;  mers 14 = 2^607-1;   mers 15 = 2^1279-1
mers 16 = 2^2203-1; mers 17 = 2^2281-1;  mers 18 = 2^3217-1
mers 19 = 2^4253-1; mers 20 = 2^4423-1;  mers 21 = 2^9689-1
mers 22 = 2^9941-1; mers 23 = 2^11213-1; mers 24 = 2^19937-1
mers 25 = 2^21701-1;
mers _  = undefined

bin2int :: [Int] -> Int
bin2int = bin . reverse where
  bin []  = 0
  bin [0] = 0
  bin [1] = 1
  bin (0:bs) = 2 * bin bs
  bin (1:bs) = 2 * bin bs + 1
  bin _      = error "not a binary digit list"

addM :: Integer -> Integer -> Integer -> Integer
addM x y = rem (x+y)

multM :: Integer -> Integer -> Integer -> Integer
multM x y = rem (x*y) 

invM :: Integer -> Integer -> Integer
invM x n = let 
   (u,v) = fctGcd x n
   copr  = x*u + v*n == 1
   i     = if signum u == 1 then u else u + n  
 in 
   if copr then i else error "no inverse"

fGcd :: Integer -> Integer -> Integer
fGcd a b = if b == 0 then a
                     else fGcd b (rem a b)

fctGcd :: Integer -> Integer -> (Integer,Integer) 
fctGcd a b = 
  if b == 0 
  then (1,0) 
  else 
     let 
       (q,r) = quotRem a b
       (s,t) = fctGcd b r 
     in (t, s - q*t)

coprime :: Integer -> Integer -> Bool
coprime n m = fGcd n m == 1

coprime' :: Integer -> Integer -> Bool
coprime' n m = let (x,y) = fctGcd n m
               in x*n + y*m == 1

data Tree a = T a [Tree a] deriving (Eq,Ord,Show)

grow :: (node -> [node]) -> node -> Tree node

grow step seed = T seed (map (grow step) (step seed))

takeT :: Int -> Tree a -> Tree a

takeT 0 (T x _) = T x []
takeT n (T x ts) = T x (map (takeT (n-1)) ts)

coprimeT :: Tree (Integer,Integer)
coprimeT = grow f (1,1) 

f :: (Integer,Integer) -> [(Integer,Integer)]
f (n,m) = [(n+m,m),(n,n+m)]

pairs :: [(Integer,Integer)]
pairs = concatMap (\ n -> zip [1..n] (repeat n)) [1..]

coprimes :: [(Integer,Integer)]
coprimes = filter (uncurry coprime) pairs

expM ::  Integer -> Integer -> Integer -> Integer
expM x y = rem (x^y)

primeTestF :: Integer -> IO Bool
primeTestF n = do 
   a <- randomRIO (2, n-1) :: IO Integer
   return (exM a (n-1) n == 1)

primeTestsF :: Int -> Integer -> IO Bool
primeTestsF k n = do
 as <- sequence $ fmap (\_-> randomRIO (2,n-1)) [1..k]
 return (all (\ a -> exM a (n-1) n == 1) as)

decomp :: Integer -> (Integer,Integer)
decomp n0 = decomp' (0,n0) where
  decomp' = until (odd.snd) (\ (m,n) -> (m+1,div n 2))

mrComposite :: Integer -> Integer -> Bool
mrComposite x n = let
    (r,s) = decomp (n-1)
    fs     = takeWhile (/= 1) 
       (map (\ j -> exM x (2^j*s) n)  [0..r])
  in 
    exM x s n /= 1 && last fs /= (n-1)

primeMR :: Int -> Integer -> IO Bool
primeMR _ 2 = return True
primeMR 0 _ = return True
primeMR k n = do 
    a <- randomRIO (2, n-1) :: IO Integer
    if exM a (n-1) n /= 1 || mrComposite a n
    then return False else primeMR (k-1) n

encodeDH :: Integer -> Integer -> Integer -> Integer
encodeDH p k m = m*k `mod` p

decodeDH :: Integer -> Integer -> Integer -> Integer -> Integer
decodeDH p ga b c = let 
    gab' = exM ga ((p-1)-b) p 
  in 
    rem (c*gab') p

encode :: Integer -> Integer -> Integer -> Integer
encode p k m = let 
   p' = p-1
   e  = head [ x | x <- [k..], gcd x p' == 1 ]
 in 
   exM m e p

decode :: Integer -> Integer -> Integer -> Integer
decode p k m = let 
   p' = p-1
   e  = head [ x | x <- [k..], gcd x p' == 1 ]
   d  = invM e p' 
 in 
   exM m d p

cipher :: Integer -> Integer
cipher = encode secret bound

decipher :: Integer -> Integer
decipher = decode secret bound

totient :: Integer -> Integer
totient n = toInteger $ length [ k | k <- [1..n], gcd k n == 1 ]

phi :: Integer -> Integer -> Integer
phi p q = (p - 1) * (q - 1)

select :: Integer -> Integer -> Integer
select p q = let
   t = phi p q 
 in
   head [ x | x <- [3..], gcd x t == 1 ]

rsaPublic :: Integer -> Integer -> (Integer,Integer)
rsaPublic p q = let
    e = select p q
  in
    (e,p*q)

rsaPrivate ::  Integer -> Integer -> (Integer,Integer)
rsaPrivate p q = let 
   e = select p q
   t = phi p q 
   d = invM e t
  in 
   (d,p*q)

rsaEncode :: (Integer,Integer) -> Integer -> Integer 
rsaEncode (e,n) m =  exM m e n

rsaDecode :: (Integer,Integer) -> Integer -> Integer 
rsaDecode = rsaEncode                              

trapdoor :: (Integer,Integer) -> Integer -> Integer
trapdoor = rsaEncode 

secret, bound :: Integer                
secret = mers 18
bound  = 131

